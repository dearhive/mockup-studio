/**
 * @preserve Copyright 2016, Deepak Ghimire.  All rights reserved.
 */
"use strict";var undef=undef||void 0;MOCKUP.Editor.prototype.addAppExplorer=function(){var e=this;var t=e.explorer={};t.fileEntry=null;t.accepts=[{extensions:["json"]}];t.open=function(){chrome.fileSystem.chooseEntry({type:"openFile",accepts:t.accepts},function(e){if(!e){output.textContent="No file selected.";return}if(e.name.indexOf(".jpg")>0){e.fileSystem.root.getFile(e.fullPath.replace(".jpg",".json"),{create:false},function(e){chrome.storage.local.set({chosenFile:chrome.fileSystem.retainEntry(e)});t.loadFile(e)},function(){1==1})}else if(e.name.indexOf(".json")>0){chrome.storage.local.set({chosenFile:chrome.fileSystem.retainEntry(e)});t.loadFile(e)}})};t.saveFile=function(t,n,a,i){if(i==true||t.indexOf(e.untitledFileName)>-1){var r={type:"saveFile",suggestedName:t.replace(".json","")+".json",accepts:e.explorer.accepts};chrome.fileSystem.chooseEntry(r,function(t){var i=new Blob([JSON.stringify(n)],{type:"text/plain"});e.explorer.writeFileEntry(t,i,function(e){a(t.name)})})}else{var s=new Blob([JSON.stringify(n)],{type:"text/plain"});e.explorer.writeFileEntry(e.explorer.fileEntry,s,function(e){a(t)})}};t.loadFile=function(n){t.fileEntry=n;t.fileEntry.file(function(i){a(t.fileEntry,function(t){t=JSON.parse(t);e.reset();e.fromJSON(t);e.currentFileName=n.name;e.updateTitle()})})};t.writeFileEntry=function(a,i,r){if(!a){return}a.createWriter(function(s){s.onerror=MOCKUP.error;s.onwriteend=r;if(i){s.truncate(i.size);n(s,function(){s.seek(0);s.write(i)})}else{t.fileEntry.file(function(e){s.truncate(e.fileSize);n(s,function(){s.seek(0);s.write(e)})})}t.fileEntry=a;e.currentFileName=a.name;e.updateTitle()},MOCKUP.error)};function n(e,t){var n=Date.now();var a=function(){if(e.readyState===e.WRITING&&Date.now()-n<4e3){setTimeout(a,100);return}if(e.readyState===e.WRITING){console.error("Write operation taking too long, aborting!"+" (current writer readyState is "+e.readyState+")");e.abort()}else{t()}};setTimeout(a,100)}function a(e,t){e.file(function(e){var n=new FileReader;n.onerror=MOCKUP.error;n.onload=function(e){t(e.target.result)};n.readAsText(e)})}};MOCKUP.Editor.prototype.addBrowserExplorer=function(){var e=this;var t=e.explorer=$("<div class='explorer'></div>");var n,a,i,r,s,o;r=$("<div class='explorer-title'><span>Click an object to select..</span></div>");s=$("<div class='explorer-close'>Cancel</div>");n=$("<div class='search'><input type='search' placeholder='Find a file..' /></div>");a=$("<div class='breadcrumbs'></div>");i=$("<ul class= 'data'></ul>");o=$("<input type='file' class='hidden-input'>");t.append(o);e.container.append(t);t.append(r);r.append(s);t.append(n);t.append(a);t.append(i);t.append("<div class='nothingfound'><div class='nofiles'></div><span>No files here.</span></div>");var l=[],f="",c,p=[];var u=[],d=[];var h;t.init=function(e){t.show();l=[e];c=e;p=[];h=Math.random();f="";u=[];d=[];g("")};t.open=function(e){if(e==true){$.ajax({type:"post",url:"request.php",data:{command:"get_files"},success:function(e){t.init(e)},dataType:"json"})}else{o.click()}};o.change(function(){var t=o[0].files;var n;if(t.length){n=t[0];n.upload={progress:0,total:n.size,bytesSent:0};var a;a=new FileReader;a.onload=function(t){return function(){o.val("");var n=a.result;if(n.stage==void 0){n=JSON.parse(n)}e.reset();e.fromJSON(n);e.currentFileName=t.name;e.updateTitle()}}(n);a.readAsText(n)}});function m(e){var t="";switch(e.code){case FileError.QUOTA_EXCEEDED_ERR:t="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:t="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:t="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:t="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:t="INVALID_STATE_ERR";break;default:t="Unknown Error";break}console.log("Error: "+t)}function v(e){console.log("Opened file system: "+e.name)}window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;navigator.webkitPersistentStorage.requestQuota(1024*1024,function(e){window.requestFileSystem(PERSISTENT,e,v,m)},function(e){console.log("Error",e)});t.saveFile=function(t,n,a,i){var r=e.download(240,160,true);var s=function(t){var a=t.trim().indexOf("data/")==0?t:"data/save/"+t;a=a.replace(".json","");function i(e,t){var n=atob(e.split(",")[1]);var a=e.split(",")[0].split(":")[1].split(";")[0];var i=new ArrayBuffer(n.length);var r=new Uint8Array(i);for(var s=0;s<n.length;s++){r[s]=n.charCodeAt(s)}return new Blob([i],{type:a})}window.requestFileSystem(window.PERSISTENT,1024*1024,function(e){e.root.getFile("image.txt",{create:true},function(e){e.createWriter(function(e){var t=new Blob(["Lorem Ipsum"],{type:"text/plain"});e.onwriteend=function(e){console.log("Write completed.")};e.onerror=function(e){console.log("Write failed: "+e.toString())};e.write(t)},m)},m)},m);$.post("request.php",{command:"save_mockup",filename:a,data:JSON.stringify(n),success:function(){e.currentFileName=a;e.updateTitle();swal({title:"Saved!",text:"Your file: "+a+" is saved",timer:1e3,type:"success",showConfirmButton:false})},image:r}).done(function(){}).fail(function(){}).always(function(){})};if(i==true||t.indexOf(this.untitledFileName)>-1){swal({title:"Save File!",text:"Got any FileName in mind?",type:"input",showCancelButton:true,closeOnConfirm:false,imageUrl:r,animation:"slide-from-top",inputPlaceholder:t,showLoaderOnConfirm:true},function(e){if(e===false)return false;if(e===""){swal.showInputError("You need to write something!");return false}s(e)})}else{s(t)}};s.on("click",function(){t.hide()});n.on("click",function(){var e=$(this);e.find("span").hide();e.find("input[type=search]").show().focus()});n.find("input").on("input",function(e){u=[];d=[];var n=this.value.trim();if(n.length){t.addClass("searching");g("search="+n.trim())}else{t.removeClass("searching");g(encodeURIComponent(f))}}).on("keyup",function(e){var t=$(this);if(e.keyCode==27){t.trigger("focusout")}}).on("focusout",function(e){var t=$(this);if(!t.val().trim().length){g(encodeURIComponent(f));t.hide();t.parent().find("span").show()}});i.on("click","li.folders",function(e){e.preventDefault();var n=$(this).find("a.folders").attr("href");if(t.hasClass("searching")){p=y(n);t.removeClass("searching");t.find("input[type=search]").val("").hide();t.find("span").show()}else{p.push(n)}g(encodeURIComponent(n));f=n});i.on("click","li.files",function(n){n.preventDefault();var a=$(this).find("a.files").attr("href");t.hide();e.loadFile(a)});a.on("click","a",function(e){e.preventDefault();var t=a.find("a").index($(this)),n=p[t];p.length=Number(t);g(encodeURIComponent(n))});function g(e){e=decodeURIComponent(e).slice(0).split("=");if(e.length){var n="";if(e[0]==="search"){t.addClass("searching");n=C(l,e[1].toLowerCase());if(n.length){f=e[0];E(n)}else{E(n)}}else if(e[0].trim().length){n=w(e[0]);if(n.length){f=e[0];p=y(e[0]);E(n)}else{f=e[0];p=y(e[0]);E(n)}}else{f=c.path;p.push(c.path);E(w(c.path))}}}function y(e){var t=e.split("/").slice(0);for(var n=1;n<t.length;n++){t[n]=t[n-1]+"/"+t[n]}return t}function w(e){var t=e.split("/"),n=l,a=0;for(var i=0;i<t.length;i++){for(var r=0;r<n.length;r++){if(n[r].name===t[i]){a=1;n=n[r].items;break}}}n=a?n:[];return n}function C(e,t){e.forEach(function(e){if(e.type==="folder"){C(e.items,t);if(e.name.toLowerCase().match(t)){u.push(e)}}else if(e.type==="file"){if(e.name.toLowerCase().match(t)){d.push(e)}}});return{folders:u,files:d}}function E(e){var n=[],r=[];if(Array.isArray(e)){e.forEach(function(e){if(e.type==="folder"){n.push(e)}else if(e.type==="file"){r.push(e)}})}else if(typeof e==="object"){n=e.folders;r=e.files}i.empty().hide();if(!n.length&&!r.length){t.find(".nothingfound").show()}else{t.find(".nothingfound").hide()}if(n.length){n.forEach(function(e){var t=e.items.length,n=x(e.name),a='<span class="icon folder"></span>';if(t){a='<span class="icon folder full"></span>'}if(t==1){t+=" item"}else if(t>1){t+=" items"}else{t="Empty"}var r=$('<li class="folders"><a href="'+e.path+'" title="'+e.path+'" class="folders">'+a+'<span class="name">'+n+'</span> <span class="details">'+t+"</span></a></li>");r.appendTo(i)})}if(r.length){r.forEach(function(e){var t=F(e.size),n=x(e.name),a=n.split("."),r='<span class="icon file"></span>';a=a[a.length-1];var s=$('<li class="files"><a href="'+e.path+'" title="'+e.path+'" class="files" style="background-image:url(\''+e.path.replace("json","jpg")+"?"+h+"')\">"+'<span class="name">'+n+'</span> <span class="details">'+t+"</span></a></li>");s.appendTo(i)})}var s="";if(t.hasClass("searching")){s="<span>Search results: </span>";i.removeClass("animated")}else{i.addClass("animated");p.forEach(function(e,t){var n=e.split("/");if(t!==p.length-1){s+='<a href="'+e+'"><span class="folderName">'+n[n.length-1]+'</span></a> <span class="arrow">→</span> '}else{s+='<span class="folderName">'+n[n.length-1]+"</span>"}})}a.text("").append(s);i.animate({display:"inline-block"})}function x(e){return e.replace(/\&/g,"&amp;").replace(/\</g,"&lt;").replace(/\>/g,"&gt;")}function F(e){var t=["Bytes","KB","MB","GB","TB"];if(e==0)return"0 Bytes";var n=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return Math.round(e/Math.pow(1024,n),2)+" "+t[n]}};MOCKUP.Editor.prototype.addExtensionExplorer=function(){if(window.chrome==void 0||window.chrome.browserAction==void 0)return;var e=this;var t=e.explorer=$("<div class='explorer'></div>");var n,a,i,r,s,o;r=$("<div class='explorer-title'><span>Click an object to select..</span></div>");s=$("<div class='explorer-close'>Cancel</div>");n=$("<div class='search'><input type='search' placeholder='Find a file..' /></div>");a=$("<div class='breadcrumbs'></div>");i=$("<ul class= 'data'></ul>");o=$("<input type='file' class='hidden-input'>");t.append(o);e.container.append(t);t.append(r);r.append(s);t.append(n);t.append(a);t.append(i);t.append("<div class='nothingfound'><div class='nofiles'></div><span>No files here.</span></div>");var l=[],f="",c,p=[];var u=[],d=[],h="";var m;MOCKUP.Editor.prototype.saveFile=function(e){var t=this;if(t.stage.hasChild()==true){var n=this.toJSON();var a=this.currentFileName;if(a.indexOf(t.untitledFileName)==0)e=true;var i=function(e){swal({title:"Saved!",text:"Your file: "+e+" is saved",timer:1e3,type:"success",showConfirmButton:false})};t.explorer.saveFile(a,n,i,e);t.autosave()}else{swal({title:"Stage is empty!",text:"Your Mockup Stage looks empty try adding some objects..",type:"info",showConfirmButton:true})}};MOCKUP.Editor.prototype.openFile=function(e){this.explorer.open(e)};var v=function(e){var t=$('<li class="files" id="'+e.id+'"  title="'+e.name+'"><a href="'+e.id+'"  title="'+e.name+'" class="files" style="background-image:url(\''+e.image+'\')"><span class="name">'+e.name+"</span></a></li>");var n=$('<span class="delete"></span>');t.append(n);t.data("type",e.type);t.data("data",e.data);i.append(t);h+=e.name+"]:["+e.id+"]),(["};t.init=function(t){p=[];m=Math.random();f="";u=[];d=[];h="]),([";var n={};e.db.mockups.where("type").equalsIgnoreCase("local").each(function(e){n[e.id]=e}).then(function(){for(var e in n){var t=n[e];v(t)}}).catch(function(e){console.error("Could not load local mockups from database: "+e.message)}).finally(function(){var e=""})};t.open=function(e){if(e==true){t.show()}else{o.click()}};o.change(function(){var t=o[0].files;var n;if(t.length){n=t[0];var a=n.name;n.upload={progress:0,total:n.size,bytesSent:0};var i;i=new FileReader;i.onload=function(t){return function(){o.val("");var t=e.readFormat(i.result,a);if(t.stage==void 0){t=JSON.parse(t)}if(t!==undef){e.reset();e.fromJSON(t)}}}(n);i.readAsText(n)}});t.fileExists=function(e){return h.indexOf("]),(["+e+"]:[")>-1};t.getFileId=function(e){var n=0;if(t.fileExists(e)){n=h.substr(h.lastIndexOf("]),(["+e+"]:[")+1).split("]),([")[0].split("]:[")[1]}return n};t.saveFile=function(n,a,i,r){var s=e.download(240,160,true);var o=function(n){var i=n.trim();i=i.replace(".json","");var r=performance.now();var o=function(t){console.log("["+/\d\d\:\d\d\:\d\d/.exec(new Date)[0]+"]","Saved state to IndexedDB. "+(performance.now()-r).toFixed(2)+"ms");swal({title:"Saved!",text:"Your file: "+i+" is saved",timer:1e3,imageUrl:s,type:"success",showConfirmButton:false});e.currentFileName=i;e.updateTitle()};var l=t.fileExists(i);var f=t.fileExists(i)?t.getFileId(i):Math.floor(Date.now());var c=l;console.log(c);if(c==true){e.db.mockups.where("id").equals(parseInt(f)).each(function(t){e.db.mockups.update(t,{image:s,data:a}).then(function(){var e=$("#"+f);e.data("data",a);e.find("a").css("background-image","url('"+s+"')");o()}).catch(function(e){console.error("Could not update mockup to database: "+e.message)}).finally(function(){})}).then(function(){}).catch(function(e){console.error("Could not update mockup to database: "+e.message)}).finally(function(){})}else{e.db.mockups.put({data:a,name:i,image:s,user:"-1",type:"local",username:"",timestamp:f,id:f}).then(function(){o();e.db.mockups.where("id").equals(parseInt(f)).each(function(e){v(e);h+=e.name+"]:["+e.id+"]),(["}).then(function(){}).catch(function(e){console.error("Could not save mockup to database: "+e.message)}).finally(function(){})}).catch(function(e){console.error("Could not save to database:"+e.message)}).finally(function(){})}if(e.user&&e.user.file!==undef){var p=e.user.file;var u={id:p.id,title:p.name,thumbnail:{image:s.replace(/^data:image\/(png|jpg|jpeg|gif);base64,/,"").replace(/\//g,"_").replace(/\+/g,"-"),mimeType:"image/png"}};var d="id,title,mimeType,userPermission,editable,copyable,shared,fileSize";var m=Math.random().toString(36).slice(2);var g="\r\n";var y=gapi.client.request({path:"/upload/drive/v2/files/"+encodeURIComponent(p.id),method:"PUT",params:{uploadType:"multipart",fields:d},headers:{Authorization:"Bearer "+e.user.token,"Content-Type":'multipart/mixed; boundary="'+m+'"'},body:g+"--"+m+g+"Content-Type: "+"application/json"+g+g+JSON.stringify(u)+g+"--"+m+g+"Content-Type: "+"application/json"+g+g+JSON.stringify(a)+g+"--"+m+"--"}).then(function(e){swal.close();var t=e.result},function(e){swal.close();console.log("Could not save file:"+e)});swal({title:"Saving data to Google Drive...",text:"Saving : "+p.name,showConfirmButton:false})}};if(r==true||n.indexOf(this.untitledFileName)>-1){swal({title:"Save File!",text:"Got any FileName in mind?",type:"input",showCancelButton:true,closeOnConfirm:false,imageUrl:s,animation:"slide-from-top",inputPlaceholder:n,showLoaderOnConfirm:true},function(e){if(e===false)return false;if(e===""){swal.showInputError("You need to write something!");return false}if(t.fileExists(e)){swal.showInputError("File already exists!!");return false}o(e)})}else{o(n)}};s.on("click",function(){t.hide()});n.on("click",function(){var e=$(this);e.find("span").hide();e.find("input[type=search]").show().focus()});n.find("input").on("input",function(e){u=[];d=[];var n=this.value.trim();if(n.length){t.addClass("searching");g("search="+n.trim())}else{t.removeClass("searching");g(encodeURIComponent(f))}}).on("keyup",function(e){var t=$(this);if(e.keyCode==27){t.trigger("focusout")}}).on("focusout",function(e){var t=$(this);if(!t.val().trim().length){g(encodeURIComponent(f));t.hide();t.parent().find("span").show()}});i.on("click","li.folders",function(e){e.preventDefault();var n=$(this).find("a.folders").attr("href");if(t.hasClass("searching")){p=y(n);t.removeClass("searching");t.find("input[type=search]").val("").hide();t.find("span").show()}else{p.push(n)}g(encodeURIComponent(n));f=n});i.on("click","li.files",function(n){n.preventDefault();var a=$(this).data("data");if(a.stage==undef){a=JSON.parse(a)}t.hide();e.reset();e.fromJSON(a);e.currentFileName=$(this).attr("title");e.updateTitle()});i.on("click","li.files .delete",function(t){t.preventDefault();t.stopPropagation();var n=$(this).siblings("a");var a=n.attr("href");var i=n.attr("title");swal({title:"Delete?",text:"Delete "+i+" ?",type:"warning",showCancelButton:true,confirmButtonColor:e.colors.red,confirmButtonText:"Delete it!",closeOnConfirm:true},function(t){if(t){e.db.mockups.where("id").equals(parseInt(a)).delete().then(function(e){if(e>0){console.log("Deleted: ("+e+") : "+i);n.closest("li.files").remove();h=h.replace(i+"]:["+a+"]),([","")}}).catch(function(e){console.error("Could not delete mockup from database: "+e.message)}).finally(function(){})}})});a.on("click","a",function(e){e.preventDefault();var t=a.find("a").index($(this)),n=p[t];p.length=Number(t);g(encodeURIComponent(n))});function g(e){e=decodeURIComponent(e).slice(0).split("=");if(e.length){var n="";if(e[0]==="search"){t.addClass("searching");n=C(l,e[1].toLowerCase());if(n.length){f=e[0];E(n)}else{E(n)}}else if(e[0].trim().length){n=w(e[0]);if(n.length){f=e[0];p=y(e[0]);E(n)}else{f=e[0];p=y(e[0]);E(n)}}else{f=c.path;p.push(c.path);E(w(c.path))}}}function y(e){var t=e.split("/").slice(0);for(var n=1;n<t.length;n++){t[n]=t[n-1]+"/"+t[n]}return t}function w(e){var t=e.split("/"),n=l,a=0;for(var i=0;i<t.length;i++){for(var r=0;r<n.length;r++){if(n[r].name===t[i]){a=1;n=n[r].items;break}}}n=a?n:[];return n}function C(e,t){e.forEach(function(e){if(e.type==="folder"){C(e.items,t);if(e.name.toLowerCase().match(t)){u.push(e)}}else if(e.type==="file"){if(e.name.toLowerCase().match(t)){d.push(e)}}});return{folders:u,files:d}}function E(e){var n=[],r=[];if(Array.isArray(e)){e.forEach(function(e){if(e.type==="folder"){n.push(e)}else if(e.type==="file"){r.push(e)}})}else if(typeof e==="object"){n=e.folders;r=e.files}i.empty().hide();if(!n.length&&!r.length){t.find(".nothingfound").show()}else{t.find(".nothingfound").hide()}if(n.length){n.forEach(function(e){var t=e.items.length,n=x(e.name),a='<span class="icon folder"></span>';if(t){a='<span class="icon folder full"></span>'}if(t==1){t+=" item"}else if(t>1){t+=" items"}else{t="Empty"}var r=$('<li class="folders"><a href="'+e.path+'" title="'+e.path+'" class="folders">'+a+'<span class="name">'+n+'</span> <span class="details">'+t+"</span></a></li>");r.appendTo(i)})}if(r.length){r.forEach(function(e){var t=F(e.size),n=x(e.name),a=n.split("."),r='<span class="icon file"></span>';a=a[a.length-1];var s=$('<li class="files"><a href="'+e.path+'" title="'+e.path+'" class="files" style="background-image:url(\''+e.path.replace("json","jpg")+"?"+m+"')\">"+'<span class="name">'+n+'</span> <span class="details">'+t+"</span></a></li>");s.appendTo(i)})}var s="";if(t.hasClass("searching")){s="<span>Search results: </span>";i.removeClass("animated")}else{i.addClass("animated");p.forEach(function(e,t){var n=e.split("/");if(t!==p.length-1){s+='<a href="'+e+'"><span class="folderName">'+n[n.length-1]+'</span></a> <span class="arrow">→</span> '}else{s+='<span class="folderName">'+n[n.length-1]+"</span>"}})}a.text("").append(s);i.animate({display:"inline-block"})}function x(e){return e.replace(/\&/g,"&amp;").replace(/\</g,"&lt;").replace(/\>/g,"&gt;")}function F(e){var t=["Bytes","KB","MB","GB","TB"];if(e==0)return"0 Bytes";var n=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return Math.round(e/Math.pow(1024,n),2)+" "+t[n]}};